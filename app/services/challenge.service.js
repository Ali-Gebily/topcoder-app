var mockChallenges = [
  {
    "updatedAt": "2014-04-04T06:04Z",
    "createdAt": "2014-03-30T08:48Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "24 hour Hercules Player Personal Content DVR iOS 1 0 9 1 Bug Hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30041541,
    "userId": 151743,
    "forumId": 22045,
    "numSubmissions": 3,
    "numRegistrants": 4,
    "registrationStartDate": "2014-03-30T16:00Z",
    "registrationEndDate": "2014-03-31T16:00Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-03-31T16:00Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Reviewer",
        "Specification Submitter",
        "Copilot"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 177052,
          "submittedAt": "2014-03-30T08:48Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30041541
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-05-09T21:11Z",
    "createdAt": "2014-05-06T21:04Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "Android",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "Hercules PCDVR Android App - Version 1 0 9 8 Bug Hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30042563,
    "userId": 151743,
    "forumId": 22846,
    "numSubmissions": 3,
    "numRegistrants": 6,
    "registrationStartDate": "2014-05-06T22:40Z",
    "registrationEndDate": "2014-05-08T22:40Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-05-08T22:40Z",
    "platforms": "Android",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Reviewer",
        "Specification Submitter",
        "Copilot"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 179562,
          "submittedAt": "2014-05-06T21:04Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30042563
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-07-02T19:46Z",
    "createdAt": "2014-06-30T03:27Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "24 hour - Hercules PCDVR iOS App - Version 1 0 9 15 bug hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30043808,
    "userId": 151743,
    "forumId": 23852,
    "numSubmissions": 4,
    "numRegistrants": 5,
    "registrationStartDate": "2014-06-30T16:00Z",
    "registrationEndDate": "2014-07-01T16:00Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-07-01T16:00Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Approver",
        "Reviewer",
        "Specification Submitter",
        "Copilot"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 183230,
          "submittedAt": "2014-06-30T03:27Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30043808
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-07-08T05:18Z",
    "createdAt": "2014-07-06T02:31Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "Android",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "Hercules PCDVR Android App - 24 hour - Version 1 0  9 17 Bug Hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30043966,
    "userId": 151743,
    "forumId": 23974,
    "numSubmissions": 5,
    "numRegistrants": 6,
    "registrationStartDate": "2014-07-06T16:00Z",
    "registrationEndDate": "2014-07-07T16:00Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-07-07T16:00Z",
    "platforms": "Android",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Reviewer",
        "Copilot",
        "Specification Submitter"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 183526,
          "submittedAt": "2014-07-06T02:31Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30043966
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-12-09T00:08Z",
    "createdAt": "2014-12-09T00:01Z",
    "createdBy": "151743",
    "updatedBy": "151743",
    "technologies": "Android",
    "status": "Deleted",
    "track": null,
    "subTrack": "First2Finish",
    "name": "Hercules OnCampus TV App - 0 min displayed on Live TV grid",
    "type": "First2Finish",
    "reviewType": "INTERNAL",
    "id": 30047806,
    "userId": 151743,
    "forumId": 27229,
    "numSubmissions": 0,
    "numRegistrants": 0,
    "registrationStartDate": "2014-12-09T00:02Z",
    "registrationEndDate": "2015-01-08T00:02Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2015-01-08T00:07Z",
    "platforms": "Android",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Approver",
        "Observer",
        "Iterative Reviewer"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": null
    },
    "projectId": 8324,
    "projectName": "Android TV",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-02-20T13:12Z",
    "createdAt": "2014-02-17T11:59Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "24 hour Hercules Player Personal Content DVR iOS 1-8-0-7 Bug Hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30039586,
    "userId": 151743,
    "forumId": 21348,
    "numSubmissions": 4,
    "numRegistrants": 6,
    "registrationStartDate": "2014-02-17T15:25Z",
    "registrationEndDate": "2014-02-19T15:25Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-02-19T15:30Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Copilot",
        "Reviewer",
        "Specification Submitter"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 171701,
          "submittedAt": "2014-02-17T12:00Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30039586
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-03-03T03:27Z",
    "createdAt": "2014-03-01T03:26Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "24 hour Hercules Player Personal Content DVR iOS 1 0 8 9 Bug Hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30040956,
    "userId": 151743,
    "forumId": 21683,
    "numSubmissions": 4,
    "numRegistrants": 5,
    "registrationStartDate": "2014-03-01T08:51Z",
    "registrationEndDate": "2014-03-02T08:51Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-03-02T08:56Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Specification Submitter",
        "Reviewer",
        "Copilot"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 174657,
          "submittedAt": "2014-03-01T03:26Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30040956
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-03-13T12:51Z",
    "createdAt": "2014-03-10T11:33Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "24 hour Hercules Player Personal Content DVR iOS 1 0 8 11 Bug Hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30041194,
    "userId": 151743,
    "forumId": 21775,
    "numSubmissions": 4,
    "numRegistrants": 7,
    "registrationStartDate": "2014-03-10T12:45Z",
    "registrationEndDate": "2014-03-11T12:45Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-03-11T12:50Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Approver",
        "Reviewer",
        "Specification Submitter",
        "Copilot"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 175391,
          "submittedAt": "2014-03-10T11:33Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30041194
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-05-09T22:06Z",
    "createdAt": "2014-05-06T20:48Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "Hercules PCDVR iOS App - Version 1 0 9 8 Bug hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30042561,
    "userId": 151743,
    "forumId": 22844,
    "numSubmissions": 3,
    "numRegistrants": 7,
    "registrationStartDate": "2014-05-06T22:09Z",
    "registrationEndDate": "2014-05-08T22:09Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-05-08T22:09Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Copilot",
        "Specification Submitter",
        "Reviewer"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 179560,
          "submittedAt": "2014-05-06T20:49Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30042561
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  },
  {
    "updatedAt": "2014-06-17T01:43Z",
    "createdAt": "2014-06-14T03:15Z",
    "createdBy": "151743",
    "updatedBy": "22841596",
    "technologies": "iOS",
    "status": "Completed",
    "track": null,
    "subTrack": "Bug Hunt",
    "name": "Hercules PCDVR iOS App - Version 1 0 9 14 Bug hunt",
    "type": "Bug Hunt",
    "reviewType": null,
    "id": 30043468,
    "userId": 151743,
    "forumId": 23565,
    "numSubmissions": 4,
    "numRegistrants": 4,
    "registrationStartDate": "2014-06-14T04:28Z",
    "registrationEndDate": "2014-06-16T04:28Z",
    "checkpointSubmissionEndDate": null,
    "submissionEndDate": "2014-06-16T04:28Z",
    "platforms": "iOS",
    "numberOfCheckpointPrizes": null,
    "totalCheckpointPrize": null,
    "isPrivate": null,
    "upcomingPhase": null,
    "userDetails": {
      "roles": [
        "Copilot",
        "Reviewer",
        "Specification Submitter"
      ],
      "hasUserSubmittedForReview": false,
      "submissionReviewScore": null,
      "winningPlacements": null,
      "submissions": [
        {
          "id": 182096,
          "submittedAt": "2014-06-14T03:15Z",
          "status": "Active",
          "score": null,
          "placement": null,
          "challengeId": 30043468
        }
      ]
    },
    "projectId": 6680,
    "projectName": "My Media",
    "handle": "Ghostar"
  }
];
(function() {
  'use strict';

  angular.module('tc.services').factory('ChallengeService', ChallengeService);

  ChallengeService.$inject = ['CONSTANTS', 'ApiService', '$q'];

  function ChallengeService(CONSTANTS, ApiService, $q) {

    var rApi = ApiService.restangularV3;
    var api = ApiService.restangularV3;

    var service = {
      getChallenges: getChallenges,
      getSpotlightChallenges: getSpotlightChallenges,
      getiOSChallenges: getiOSChallenges,
      getMyMarathonMatches: _getMyMarathonMatches,
      getReviewEndDate: getReviewEndDate,
      getChallengeDetails: getChallengeDetails
    };
    return service;

    function getChallenges(params) {
      var deferred = $q.defer();
      var data = mockChallenges;
      deferred.resolve(data);
      return deferred.promise;
      // api.all('challenges').getList(params);
    }

    function getSpotlightChallenges() {
      var deferred = $q.defer();

      var mockChallenges = [
        {
          challengeName: 'Styx iOS Video Mobile App Bug Fixes - 177+214',
          challengeType: 'Code',
          totalPrize: '1200',
          registrationStartDate: '2015-05-01T00:00:00.000-0400',
          track: 'DESIGN',
          numRegistrants: 21,
          numSubmissions: 8
        },
        {
          challengeName: 'Styx iOS Video Mobile App Bug Fixes - 177+214',
          challengeType: 'Code',
          totalPrize: '1200',
          registrationStartDate: '2015-05-01T00:00:00.000-0400',
          track: 'DESIGN',
          numRegistrants: 21,
          numSubmissions: 8
        }
      ];

      deferred.resolve(mockChallenges);

      return deferred.promise;
    }

    function getiOSChallenges() {
      var iOSParams = {
        filter: "technologies=ios&status=active",
        limit: 3,
        offset: 0,
      };
      return api.all('challenges').getList(iOSParams);
    }

    /** NOT USED NEEDS TO BE REFACTORED **/

    function _getMyActiveChallenges(request) {
      var deferred = $q.defer();

      var prevRequest = rApi.request;

      // If my active challenges has already been retrieved, simply return it
      if(rApi.myActiveChallenges && rApi.myActiveChallenges != "waiting" && !uniqueRequest(prevRequest, request)) {
        deferred.resolve(rApi.myActiveChallenges);
      } else {
        // Otherwise, set state to waiting, so that only one call is done to the server
        rApi.myActiveChallenges = "waiting";

        // Add promise to list to it can be resolved when call returns
        rApi.activeChallengeDeferredList.push(deferred);

        // add default paging
        var pageIndex = request && request.pageIndex ? request.pageIndex : 1;
        var pageSize = request && request.pageSize ? request.pageSize : 10;
        var sortColumn  = request && request.sortColumn ? request.sortColumn : 'submissionEndDate';
        var sortOrder  = request && request.sortOrder ? request.sortOrder : 'asc';
        var listType  = request && request.listType ? request.listType : 'active';
        var userId  = request && request.userId ? request.userId : null;

        rApi.request = request;

        var filter = [];
        if (listType) {
          filter.push("listType=" + listType);
        }
        if (userId) {
          filter.push("userId=" + userId);
        }
        filter = filter.join("&");

        // Fetch list of active challenges for current user
        rApi.all("challenges").getList({
            type: listType,
            pageIndex: pageIndex,
            pageSize: pageSize,
            sortColumn: sortColumn,
            sortOrder: sortOrder
          }).then(function(data) {
            // Sets the data, and returns it to all pending promises
            rApi.myActiveChallenges = data;
            angular.forEach(rApi.activeChallengeDeferredList, function(def) {
              def.resolve(rApi.myActiveChallenges);
            });
            rApi.activeChallengeDeferredList = [];
            return rApi.myActiveChallenges;
          });
      }

      return deferred.promise;
    }

    function _getMyMarathonMatches(request) {
      var deferred, listType, prevRequest, sortColumn, sortOrder;
      deferred = $q.defer();
      prevRequest = rApi.mmRequest;
      if (rApi.myMarathonMatches && rApi.myMarathonMatches !== 'waiting') {
        deferred.resolve(rApi.myMarathonMatches);
      } else {
        rApi.myMarathonMatches = 'waiting';
        rApi.marathonMatchesDeferredList.push(deferred);
        sortColumn = request && request.sortColumn ? request.sortColumn : 'submissionEndDate';
        sortOrder = request && request.sortOrder ? request.sortOrder : 'asc';
        listType = request && request.type ? request.type : 'active';
        rApi.request = request;
        rApi.all('marathonMatches').getList({
          listType: listType,
          sortColumn: sortColumn,
          sortOrder: sortOrder
        }).then(function(data) {
          rApi.myMarathonMatches = data;
          angular.forEach(rApi.marathonMatchesDeferredList, function(def) {
            def.resolve(rApi.myMarathonMatches);
          });
          rApi.marathonMatchesDeferredList = [];
          return rApi.myMarathonMatches;
        });
      }
      return deferred.promise;
    }
    function _uniqueRequest(prevRequest, currRequest) {
      if (!prevRequest || !currRequest) return true;
      return prevRequest.pageIndex != currRequest.pageIndex ||
        prevRequest.pageSize != currRequest.pageSize ||
        prevRequest.sortColumn != currRequest.sortColumn ||
        prevRequest.sortOrder != currRequest.sortOrder ||
        prevRequest.listType != currRequest.listType;
    }

    function getReviewEndDate(challengeId) {
      var url = CONSTANTS.API_URL + '/phases/?filter=' + encodeURIComponent('challengeId=' + challengeId + ' & phaseType=4');
      return ApiService.requestHandler('GET', url);
    }

    function getChallengeDetails(challengeId) {
      var url = CONSTANTS.API_URL_V2 + '/challenges/' + challengeId;
      return ApiService.requestHandler('GET', url, {}, true);
    }

  };

})();
